flowchart TD
    Start([User Query]) --> Parse[Main Agent: Parse Query]
    Parse --> Detect{Service Detected?}

    %% Service Detection
    Detect -->|Gmail: email, inbox, send, compose| RouteGmail[Gmail Agent Router]
    Detect -->|Drive: file, document, upload, share| RouteDrive[Drive Agent Router]
    Detect -->|Calendar: meeting, event, schedule| RouteCal[Calendar Agent Router]
    Detect -->|Search: search, find, google, who is, research| RouteSearch[Search Agent Router]
    %% Detect -->|Multiple Services| RouteMulti[Multi-Agent Orchestration]
    Detect -->|None / General| RouteGeneral[General LLM Response]

    %% Gmail Branch
    RouteGmail --> AuthG{Gmail Auth Valid?}
    AuthG -- Yes --> GmailTools[Gmail Tools]
    AuthG -- No --> RefreshG[Gmail Token Refresh] --> AuthG
    GmailTools --> G1["Search Emails<br/>search_emails(query)"]
    GmailTools --> G2["Send Email<br/>send_email(to, subject, body)"]
    GmailTools --> G3["Read Thread<br/>get_thread(id)"]

    %% Drive Branch (UPDATED: Current vs Future)
    RouteDrive --> AuthD{Drive Auth Valid?}
    AuthD -- Yes --> DriveTools[Drive Tools]
    AuthD -- No --> RefreshD[Drive Token Refresh] --> AuthD
    DriveTools --> D1["âœ… List Files<br/>search_files(query)"]
    DriveTools --> D2["âœ… Read Files<br/>download_file(id)"]
    DriveTools --> D3["ðŸš§ FUTURE: Share<br/>share_file(id, email)"]
    DriveTools --> D4["ðŸš§ FUTURE: Upload<br/>upload_file(path)"]
    DriveTools --> D5["ðŸš§ FUTURE: Delete<br/>delete_file(id)"]

    %% Calendar Branch
    RouteCal --> AuthC{Calendar Auth Valid?}
    AuthC -- Yes --> CalTools[Calendar Tools]
    AuthC -- No --> RefreshC[Calendar Token Refresh] --> AuthC
    CalTools --> C1["Create Event<br/>create_event(...)"]
    CalTools --> C2["Find Free Time<br/>find_free_slots()"]
    CalTools --> C3["List Events<br/>get_events(range)"]

    %% Search Agent Branch
    RouteSearch --> SearchTools[Search Agent Tools]
    SearchTools --> S1["Web Search<br/>web_search(query)"]
    SearchTools --> S2["Browse Page<br/>browse_url(url, instructions)"]
    SearchTools --> S4["X/Twitter Search<br/>twitter_search(query)"]
    SearchTools --> S5["Summarize Results<br/>summarize(results)"]

    %% Convergence (UPDATED for new Drive nodes)
    G1 & G2 & G3 --> Format
    D1 & D2 & D3 & D4 & D5 --> Format
    C1 & C2 & C3 --> Format
    S1 & S2 & S4 & S5 --> Format
    RouteGeneral --> Format

    Format[Main Agent: Aggregate & Format Response] --> Log[Log Interaction + Tools Used]
    Log --> End([Return Final Answer to User])

    %% Styling
    classDef startEnd fill:#1DB954,stroke:#fff,color:white,font-weight:bold
    classDef decision fill:#FF5722,stroke:#fff,color:white
    classDef process fill:#2196F3,stroke:#fff,color:white
    classDef tools fill:#9C27B0,stroke:#fff,color:white
    classDef search fill:#FF9800,stroke:#fff,color:white
    classDef auth fill:#607D8B,stroke:#fff,color:white

    class Start,End startEnd
    class Detect,AuthG,AuthD,AuthC decision
    class Parse,RouteGmail,RouteDrive,RouteCal,RouteSearch,RouteMulti,RouteGeneral,RefreshG,RefreshD,RefreshC,Format,Log,SearchTools,DriveTools process
    class G1,G2,G3,D1,D2,D3,D4,D5,C1,C2,C3 tools
    class S1,S2,S4,S5 search